<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8 lt-ie7" lang="en-us"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8" lang="en-us"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if IE 9]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if lt IE 10]> <html class="no-js lt-ie10" lang="en-us"> <![endif]-->
<!--[if !IE]> > <![endif]-->
<html class='no-js' lang='en'>
<!-- <![endif] -->
<head>
<title>
Buildah Blocks- Buildah builds itself! &mdash;
Project Atomic
</title>
<meta charset='utf-8'>
<meta content='' name='description'>
<meta content='Tom Sweeney' name='author'>
<meta content='initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width' name='viewport'>
<link href='/blog/feed.xml' rel='alternate' title='Atom feed' type='application/atom+xml'>
<!-- Open Graph (FB / G+) -->
<meta content='article' property='og:type'>
<meta content='Buildah Blocks- Buildah builds itself!' property='og:title'>
<meta content='I’m a fan of Isaac Asimov’s Three Laws of Robotics and I’m beginning to wonder if these laws need to be wired into Buildah. You see Buildah builds itself. It’s self-propagating.' property='og:description'>
<meta content='https://www.projectatomic.io/blog/2018/02/buildah-builds-itself/' property='og:url'>
<meta content='2018-02-27T00:00:00Z' property='article:published_time'>
<meta content='tsweeney' property='article:author:username'>
<meta content='atomic' property='article:tag'>
<link href='/blog/tag/atomic.xml' rel='alternate' title='Atom feed' type='application/atom+xml'>
<meta content='buildah' property='article:tag'>
<link href='/blog/tag/buildah.xml' rel='alternate' title='Atom feed' type='application/atom+xml'>
<meta content='containers' property='article:tag'>
<link href='/blog/tag/containers.xml' rel='alternate' title='Atom feed' type='application/atom+xml'>
<!-- Twitter card -->
<meta content='summary' name='twitter:card'>
<meta content='Buildah Blocks- Buildah builds itself!' name='twitter:title'>
<meta content='I’m a fan of Isaac Asimov’s Three Laws of Robotics and I’m beginning to wonder if these laws need to be wired into Buildah. You see Buildah builds itself. It’s self-propagating.' name='twitter:description'>

<link href='/images/favicon.ico' rel='shortcut icon'>
<link href='/images/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'>
<link href='/images/apple-touch-icon-57x57-precomposed.png' rel='apple-touch-icon-precomposed' sizes='57x57'>
<link href='/images/apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/images/apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='/blog/feed.xml' rel='alternate' title='Project Atomic' type='application/atom+xml'>
<link href="/stylesheets/application.css?1633620577" rel="stylesheet" type="text/css" />
<link href="/stylesheets/print.css?1633620578" rel="stylesheet" type="text/css" media="print" />
</head>
<body class=' blog blog_2018 blog_2018_02 blog_2018_02_buildah-builds-itself blog_2018_02_buildah-builds-itself_index source-md'>
<section class='container' id='page-wrap'>
<div class='row'>
<div class='col-md-3 col-lg-2' id='sidebar'>
<div id='nav-primary'>
<nav class='navbar navbar-default' role='navigation'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse'>
<span class='sr-only'>
Toggle navigation
</span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
<a class='navbar-brand' href='/'>
Project Atomic
</a>
</div>
<div class='collapse navbar-collapse navbar-ex1-collapse'>
<ul class='nav navbar-nav'>
<li><a class="get-started" href="/download">Get Started</a></li>
<li><a class="documentation" href="/docs">Documentation</a></li>
<li><a class="developer-community" href="/community">Developer Community</a></li>
<li><a class="talks" href="/community/talks">Talks</a></li>
<li><a class="on-github" href="https://github.com/projectatomic/">On GitHub</a></li>
<li><a class="blog" href="/blog">Blog</a></li>
<li><a class="twitter" href="http://www.twitter.com/projectatomic">Twitter</a></li>
<li><a class="rss" href="../../../feed.xml">RSS</a></li>
</ul>
</div>
</nav>

</div>

</div>
<section class='col-lg-10 col-md-9 container' id='content'>
<!--[if lt IE 7]>
<p class="chromeframe">You are using an outdated browser.
<a href="http://browsehappy.com/">Upgrade your browser today</a> or
<a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
<![endif]-->
<section class='blog-post-page row'>
<div class='col-md-12'>
<article class='post hentry'>
<header class='post-header'>
<h2 class='post-title entry-title'>
Buildah Blocks- Buildah builds itself!
</h2>
<p class='post-meta'>
<span class='byline'>
by
</span>
<span class='author vcard'>
<a href="/blog/author/tsweeney/">Tom Sweeney</a>
</span>
&ndash;
<time class='published' datetime='2018-02-27T00:00:00Z'>
Tuesday 27 February 2018
</time>
</p>
</header>
<section class='post-content entry-content'>
<p>I’m a fan of Isaac Asimov’s <a href="https://en.wikipedia.org/wiki/Three_Laws_of_Robotics"><q>Three Laws of Robotics</q></a> and I&rsquo;m beginning to wonder if these laws need to be wired into <a href="https://github.com/projectatomic/buildah">Buildah</a>. You see Buildah builds itself. It’s self-propagating.</p>

<p></p>

<p>We recently were building out our test system for Buildah and for part of that testing we needed to make sure Buildah&rsquo;s RPM would build.  Buildah uses Travis CI to do its testing and within our test bats file we create a container and then the RPM within it to make sure the RPM builds appropriately. While reviewing the code for that test, I commented that it would be nice if we could create a second container to install the RPM on and maybe make sure the command <code>buildah help</code> worked.</p>

<p>Nalin Dahyabhai, who started the Buildah project, one upped that (truth be told, that&rsquo;s Nalin&rsquo;s Standard Operating Procedure).  What he put together was deceptively simple, yet extremely powerful.</p>

<p>First Nalin creates a container using the command ‘buildah from’ using Fedora 27.  This creates a container that runs Fedora 27.  He then uses ‘buildah mount’ to get the location of the container’s root file system and saves that to the ‘$root’ variable.  Once that’s in hand, a directory is created for the rpm bits and pieces to be placed into that will be needed to make an RPM for Buildah.</p>
<pre class="highlight plaintext"><code># Build a container to use for building the binaries.&#x000A;        image=registry.fedoraproject.org/fedora:27&#x000A;        cid=$(buildah --debug=false from --pull --signature-policy ${TESTSDIR}/policy.json $image)&#x000A;        root=$(buildah --debug=false mount $cid)&#x000A;        commit=$(git log --format=%H -n 1)&#x000A;        shortcommit=$(echo ${commit} | cut -c-7)&#x000A;        mkdir -p ${root}/rpmbuild/{SOURCES,SPECS}&#x000A;</code></pre>

<p>Now that a container is ready, the necessary spec files are put in place and rpmbuild is invoked on the container to make the rpm file for Buildah.</p>
<pre class="highlight plaintext"><code># Build the tarball.&#x000A;(cd ..; git archive --format tar.gz --prefix=buildah-${commit}/ ${commit}) &gt; ${root}/rpmbuild/SOURCES/buildah-${shortcommit}.tar.gz&#x000A;&#x000A;# Update the .spec file with the commit ID.&#x000A;sed s:REPLACEWITHCOMMITID:${commit}:g ${TESTSDIR}/../contrib/rpm/buildah.spec &gt; ${root}/rpmbuild/SPECS/buildah.spec&#x000A;&#x000A;# Install build dependencies and build binary packages.&#x000A;buildah --debug=false run $cid -- dnf -y install 'dnf-command(builddep)' rpm-build&#x000A;buildah --debug=false run $cid -- dnf -y builddep --spec rpmbuild/SPECS/buildah.spec&#x000A;buildah --debug=false run $cid -- rpmbuild --define "_topdir /rpmbuild" -ba /rpmbuild/SPECS/buildah.spec&#x000A;</code></pre>

<p>Then a second container is built again using Fedora 27 and the rpm file that was built on the first container is copied into this new container. Then the rpm is installed using dnf. Buildah has now been installed onto the new container with the latest bits from GitHub.</p>
<pre class="highlight plaintext"><code># Build a second new container.&#x000A;cid2=$(buildah --debug=false from --pull --signature-policy ${TESTSDIR}/policy.json registry.fedoraproject.org/fedora:&#x000A;root2=$(buildah --debug=false mount $cid2)&#x000A;&#x000A;# Copy the binary packages from the first container to the second one and build a list of&#x000A;# their filenames relative to the root of the second container.&#x000A;rpms=&#x000A;mkdir -p ${root2}/packages&#x000A;for rpm in ${root}/rpmbuild/RPMS/*/*.rpm ; do&#x000A;cp $rpm ${root2}/packages/&#x000A;rpms="$rpms "/packages/$(basename $rpm)&#x000A;done&#x000A;&#x000A;# Install the binary packages into the second container.&#x000A;buildah --debug=false run $cid2 -- dnf -y install $rpms&#x000A;</code></pre>

<p>With the new container up and running, Nalin&rsquo;s able to run a number of commands in the container pulling out key information to verify that the rpm is installed and works as expected.</p>
<pre class="highlight plaintext"><code># Run the binary package and compare its self-identified version to the one we tried to build.&#x000A;id=$(buildah --debug=false run $cid2 -- buildah version | awk '/^Git Commit:/ { print $NF }')&#x000A;bv=$(buildah --debug=false run $cid2 -- buildah version | awk '/^Version:/ { print $NF }')&#x000A;rv=$(buildah --debug=false run $cid2 -- rpm -q --queryformat '%{version}' buildah)&#x000A;echo "short commit: $shortcommit"&#x000A;echo "id: $id"&#x000A;echo "buildah version: $bv"&#x000A;echo "buildah rpm version: $rv"&#x000A;test $shortcommit = $id&#x000A;test $bv = $rv&#x000A;</code></pre>

<p>There you have it, Buildah building and testing itself.  Granted I’m not too worried if Buildah doesn’t follow the <q>Three Laws of Robotics</q> at this point, but this technique is really powerful. This test runs on each and every pull request to Buildah. If the RPM can’t be built, installed and minimal operations completed, the tests won’t run and the code won’t get committed.</p>

<p>For more information on Buildah check it out on <a href="https://github.com/projectatomic/buildah">GitHub</a> - also checkout the <a href="https://github.com/projectatomic/buildah/blob/master/tests/rpm.bats">rpm.bats</a> file there which is where code examples in this blog came from.  If you’re interested, we’d love to have you become a contributor on the project.</p>

<p><strong>Buildah == Simplicity</strong></p>

</section>
<footer class='post-meta'>
<div class='tags'>
Tags:
<ul class='taglist'>
<li><a href="/blog/tag/atomic/">atomic</a></li>
<li><a href="/blog/tag/buildah/">buildah</a></li>
<li><a href="/blog/tag/containers/">containers</a></li>
</ul>
</div>

<p>
<small>Share this post:</small>
<span class='btn-group' id='social_share'>
<a class='btn btn-default btn-xs' href='http://twitter.com/share?text=yourtext&amp;url=http://www.projectatomic.io/blog/2018/02/buildah-builds-itself/' role='button' title='Twitter'>
<i class='fa fa-twitter'></i>
Twitter
</a>
<a class='btn btn-default btn-xs' href='http://www.facebook.com/sharer.php?u=http://www.projectatomic.io/blog/2018/02/buildah-builds-itself/' role='button' title='Facebook'>
<i class='fa fa-facebook'></i>
Facebook
</a>
<a class='btn btn-default btn-xs' href='https://plus.google.com/share?url=http://www.projectatomic.io/blog/2018/02/buildah-builds-itself/' role='button' title='Google'>
<i class='fa fa-google-plus'></i>
Google+
</a>
</span>
</p>

</footer>
</article>

<section id='blog-comments'></section>
</div>
</section>

</section>
</div>
<div class='row'>
<div class='col-md-offset-3 col-md-9 col-lg-offset-2 col-lg-10' id='footer'>
<footer>
<hr class='visible-print'>
<ul class='footer-nav-list'>
<li><a target="_blank" href="https://fedoraproject.org/wiki/Legal:PrivacyPolicy">Privacy Policy</a></li>
</ul>

&copy; 2014&ndash;2021 Project Atomic. Sponsored by Red Hat, Inc.
        <script type="text/javascript">
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http") + "://tracker.osci.io/piwik/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', 4]);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
        g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
        </script>
<noscript><p><img src="https://tracker.osci.io/piwik/piwik.php?idsite=4" style="border:0;" alt="" /></p></noscript>
</footer>
</div>
</div>

</section>

<script src="/javascripts/application.js?1633620584" type="text/javascript"></script>


</body>
</html>

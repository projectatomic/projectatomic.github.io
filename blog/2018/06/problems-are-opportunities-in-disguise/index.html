<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8 lt-ie7" lang="en-us"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8" lang="en-us"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if IE 9]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if lt IE 10]> <html class="no-js lt-ie10" lang="en-us"> <![endif]-->
<!--[if !IE]> > <![endif]-->
<html class='no-js' lang='en'>
<!-- <![endif] -->
<head>
<title>
Problems Are Just Opportunities in Disguise &mdash;
Project Atomic
</title>
<meta charset='utf-8'>
<meta content='' name='description'>
<meta content='Tom Sweeney' name='author'>
<meta content='initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width' name='viewport'>
<link href='/blog/feed.xml' rel='alternate' title='Atom feed' type='application/atom+xml'>
<!-- Open Graph (FB / G+) -->
<meta content='article' property='og:type'>
<meta content='Problems Are Just Opportunities in Disguise' property='og:title'>
<meta content='As a father who’s ushered one child through their teen years, and with two more in the teens now, I know about problems. Problems with the WiFi not working, or the shoes that are two months old and now two sizes too small. Those are the easy ones, the harder ones come in with sleepovers with their significant others, the broken down car after curfew or the death of a classmate. In my at-work life, I was explaining to my scrum master that I’d not been picking off any cards off our board in the past sprint because I’d spent all my time working on issues. He remarked that as a software engineer we’re not so much coders as we’re problem solvers. I guess I can’t escape problems either at work or at home.&#x000A;&#x000A;Recently one of the folks that talks about Buildah, Podman, and other related container technologies at conferences sent me an email about a problem he was having with a demo script he was hoping to show.' property='og:description'>
<meta content='https://www.projectatomic.io/blog/2018/06/problems-are-opportunities-in-disguise/' property='og:url'>
<meta content='2018-06-07T00:00:00Z' property='article:published_time'>
<meta content='tsweeney' property='article:author:username'>
<!-- Twitter card -->
<meta content='summary' name='twitter:card'>
<meta content='Problems Are Just Opportunities in Disguise' name='twitter:title'>
<meta content='As a father who’s ushered one child through their teen years, and with two more in the teens now, I know about problems. Problems with the WiFi not working, or the shoes that are two months old and now two sizes too small. Those are the easy ones, the harder ones come in with sleepovers with their significant others, the broken down car after curfew or the death of a classmate. In my at-work life, I was explaining to my scrum master that I’d not been picking off any cards off our board in the past sprint because I’d spent all my time working on issues. He remarked that as a software engineer we’re not so much coders as we’re problem solvers. I guess I can’t escape problems either at work or at home.&#x000A;&#x000A;Recently one of the folks that talks about Buildah, Podman, and other related container technologies at conferences sent me an email about a problem he was having with a demo script he was hoping to show.' name='twitter:description'>

<link href='/images/favicon.ico' rel='shortcut icon'>
<link href='/images/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'>
<link href='/images/apple-touch-icon-57x57-precomposed.png' rel='apple-touch-icon-precomposed' sizes='57x57'>
<link href='/images/apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/images/apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='/blog/feed.xml' rel='alternate' title='Project Atomic' type='application/atom+xml'>
<link href="/stylesheets/application.css?1633620577" rel="stylesheet" type="text/css" />
<link href="/stylesheets/print.css?1633620578" rel="stylesheet" type="text/css" media="print" />
<div class="alert alert-danger">
<h2> Project Atomic is now sunset</h2>
<p>
The Atomic Host platform is now replaced by <a href="https://coreos.fedoraproject.org">CoreOS</a>.
Users of Atomic Host are encouraged to join the CoreOS community on the IRC channel <a href="irc://irc.freenode.org/#fedora-coreos">#fedora-coreos</a> or on the <a href="https://discussion.fedoraproject.org/c/server/coreos">discussion board</a>.
</p>
<p>
The documentation contained below and throughout this site has been retained for historical purposes, but can no longer be guaranteed to be accurate.
</p>
</div>

</head>
<body class=' blog blog_2018 blog_2018_06 blog_2018_06_problems-are-opportunities-in-disguise blog_2018_06_problems-are-opportunities-in-disguise_index source-md'>
<section class='container' id='page-wrap'>
<div class='row'>
<div class='col-md-3 col-lg-2' id='sidebar'>
<div id='nav-primary'>
<nav class='navbar navbar-default' role='navigation'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse'>
<span class='sr-only'>
Toggle navigation
</span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
<a class='navbar-brand' href='/'>
Project Atomic
</a>
</div>
<div class='collapse navbar-collapse navbar-ex1-collapse'>
<ul class='nav navbar-nav'>
<li><a class="get-started" href="/download">Get Started</a></li>
<li><a class="documentation" href="/docs">Documentation</a></li>
<li><a class="developer-community" href="/community">Developer Community</a></li>
<li><a class="talks" href="/community/talks">Talks</a></li>
<li><a class="on-github" href="https://github.com/projectatomic/">On GitHub</a></li>
<li><a class="blog" href="/blog">Blog</a></li>
<li><a class="twitter" href="http://www.twitter.com/projectatomic">Twitter</a></li>
<li><a class="rss" href="../../../feed.xml">RSS</a></li>
</ul>
</div>
</nav>

</div>

</div>
<section class='col-lg-10 col-md-9 container' id='content'>
<!--[if lt IE 7]>
<p class="chromeframe">You are using an outdated browser.
<a href="http://browsehappy.com/">Upgrade your browser today</a> or
<a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
<![endif]-->
<section class='blog-post-page row'>
<div class='col-md-12'>
<article class='post hentry'>
<header class='post-header'>
<h2 class='post-title entry-title'>
Problems Are Just Opportunities in Disguise
</h2>
<p class='post-meta'>
<span class='byline'>
by
</span>
<span class='author vcard'>
<a href="/blog/author/tsweeney/">Tom Sweeney</a>
</span>
&ndash;
<time class='published' datetime='2018-06-07T00:00:00Z'>
Thursday  7 June 2018
</time>
</p>
</header>
<section class='post-content entry-content'>
<p>As a father who&rsquo;s ushered one child through their teen years, and with two more in the teens now, I know about problems. Problems with the WiFi not working, or the shoes that are two months old and now two sizes too small. Those are the easy ones, the harder ones come in with sleepovers with their significant others, the broken down car after curfew or the death of a classmate. In my <q>at-work</q> life, I was explaining to my scrum master that I&rsquo;d not been picking off any cards off our board in the past sprint because I&rsquo;d spent all my time working on issues. He remarked that as a software engineer we&rsquo;re not so much coders as we&rsquo;re problem solvers. I guess I can&rsquo;t escape problems either at work or at home.</p>

<p>Recently one of the folks that talks about Buildah, Podman, and other related container technologies at conferences sent me an email about a problem he was having with a demo script he was hoping to show.</p>

<p></p>

<p>This script had worked in the past, but wasn&rsquo;t working now, and the next conference he was going to show it at was just days away. What unfolded from that discussion reminded me of my discussion with my scrum master that not all problems that we face as software engineers are always just a bug in the code. Sometimes it&rsquo;s the environment that our code finds itself in.</p>

<p>The script that had become problematic is a demo script that creates a Fedora 28 based container using Buildah and then installs the nginx httpd server within it. Podman is then used to run the container and to kick off the nginx server. You can find the full script <a href="https://github.com/projectatomic/buildah/blob/master/demos/buildah-bud-demo.sh">here</a> which is a really great script when you&rsquo;re running it as a demo or to learn about Buildah. However with the deadline before the next conference ticking away, the pause instructions in the script that allow for an explanation during a conference were proving to be too slow while trying to figure out the problem. So I shrunk the script down and it resulted in this:</p>
<pre class="highlight plaintext"><code>cat ~/tom_nginx.sh&#x000A;#!/bin/bash&#x000A;&#x000A;# docker-compatibility-demo.sh&#x000A;# author : demodude&#x000A;# Assumptions install buildah, podman &amp; docker&#x000A;# Do NOT start the docker deamon&#x000A;# Set some of the variables below&#x000A;&#x000A;demoimg=dockercompatibilitydemo&#x000A;quayuser=ipbabble&#x000A;myname="Demo King"&#x000A;distro=fedora&#x000A;distrorelease=28&#x000A;pkgmgr=dnf # switch to yum if using yum&#x000A;&#x000A;#Setting up some colors for helping read the demo output&#x000A;bold=$(tput bold)&#x000A;red=$(tput setaf 1)&#x000A;green=$(tput setaf 2)&#x000A;yellow=$(tput setaf 3)&#x000A;blue=$(tput setaf 4)&#x000A;cyan=$(tput setaf 6)&#x000A;reset=$(tput sgr0)&#x000A;&#x000A;echo -e "Using ${green}GREEN${reset} to introduce Buildah steps"&#x000A;echo -e "Using ${yellow}YELLOW${reset} to introduce code"&#x000A;echo -e "Using ${blue}BLUE${reset} to introduce Podman steps"&#x000A;echo -e "Using ${cyan}CYAN${reset} to introduce bash commands"&#x000A;echo -e "Using ${red}RED${reset} to introduce Docker commands"&#x000A;&#x000A;echo -e "Building an image called ${demoimg}"&#x000A;&#x000A;set -x&#x000A;newcontainer=$(buildah from ${distro})&#x000A;buildah run $newcontainer -- ${pkgmgr} -y update &amp;&amp; ${pkgmgr} -y clean all&#x000A;buildah run $newcontainer -- ${pkgmgr} -y install nginx &amp;&amp; ${pkgmgr} -y clean all&#x000A;buildah run $newcontainer bash -c 'echo "daemon off;" &gt;&gt; /etc/nginx/nginx.conf'&#x000A;buildah run $newcontainer bash -c 'echo "nginx on OCI Fedora image, built using Buildah" &gt; /usr/share/nginx/html/index.html'&#x000A;buildah config --port 80 --entrypoint /usr/sbin/nginx $newcontainer&#x000A;buildah config --created-by "${quayuser}" $newcontainer&#x000A;buildah config --author "${myname}" --label name=$demoimg $newcontainer&#x000A;buildah inspect $newcontainer&#x000A;buildah commit $newcontainer $demoimg&#x000A;buildah images&#x000A;containernum=$(podman run -d -p 80:80 $demoimg)&#x000A;curl localhost # Failed&#x000A;podman ps&#x000A;podman stop $containernum&#x000A;podman rm $containernum&#x000A;&#x000A;</code></pre>

<p>In the script you can see that a new Fedora container was created using <code>buildah from</code> and then in the next four steps <code>buildah run</code> was employed to do some configurations in the container. The first two commands do a <code>dnf update</code> and then use dnf again to install nginx and then clean everything up. The next two run commands ready nginx for running, the first one sets up the /etc/nginx/nginx.conf file and sets ‘daemon off&rsquo; in it, and then the next run command creates the index.html file to be displayed.</p>

<p>The three <code>buildah config</code> commands then do a little housekeeping within the container. They set up port 80, set the entrypoint to nginx, and then touch up the created-by, author and label fields in the new container. At this point the container is all set up such that it could run nginx and the <code>buildah inspect</code> command lets you walk through the fields and associated metadata of the container to verify all of that.</p>

<p>For the purpose of this script it was decided to run the container and the nginx server using Podman. Podman is a new open source utility for working with Linux containers and Kubernetes pods that emulates many features of the docker command line, but doesn&rsquo;t require a daemon like Docker does.</p>

<p>In order to let Podman run the container, it first must be saved as an image and that&rsquo;s what occurs with the <code>buildah commit</code> line. Then finally in the <code>podman run</code> line, we started up the container and due to the way that we configured it with the entrypoint and setting up the ports, the nginx server was started up and available for use. It&rsquo;s always nice to say the server is “running” but the proof in the pudding is being able to interact with the server. So a simple <code>curl localhost</code> was executed and we should see the index.html which simply contains:</p>

<p><code>nginx on OCI Fedora image, built using Buildah</code></p>

<p>However with only hours before the next demo, instead it sent back:</p>

<p><code>curl: (7) Failed to connect to jappa.cos.redhat.com port 80: Connection refused</code></p>

<p>Now that&rsquo;s not good. I talked to the folks on the Podman team and they were not able to reproduce the problem, so this was possibly a problem in Buildah. A flurry of debugging and checking was done in the config code to make sure the ports were being set up properly, the image was getting pulled correctly and then saved. It all checked out. Prior run throughs of the demo had all completed successfully, the nginx server would serve up the index.html as expected. That was odd, and no recent changes to the Buildah code that would likely upset any of that.</p>

<p>So at this point I went ahead and chopped down the original script down to the one in this article and started running it. On my development virtual machine (vm) I was having the problem repeatedly. I added debugging statements and wasn&rsquo;t find anything. Strangely if I replace ‘podman&rsquo; with ‘docker&rsquo; in the script, everything worked just fine. As I&rsquo;m not always very kind to my development vm, I set up a new VM and installed everything nice and fresh and clean.</p>

<p>The first pass through and the script failed there as well, so my development vm wasn&rsquo;t behaving badly by itself. I ran the script a number of times while I was thinking things through, hoping to pick something up from the output that would garner a clue. My next thought was to get into the container and look around in there. So I commented out the stop and rm lines from the script, reran it and used:</p>

<p><code>podman exec --tty 129d4d33169f /bin/bash</code></p>

<p>Where <code>129d4d33169f</code> was the ‘CONTAINER ID&rsquo; value from the <code>podman ps</code> command for the container. I did <code>curl localhost</code> there within the container and voilà! I received the output from the index.html that I wanted. I then exited the container and tried the curl command again from the host running the container and this time it worked. Finally light dawned on marblehead. In past testings I&rsquo;d been playing with an Apache httpd server and trying to connect to it from another session. In those tests if I went too quick, the server would reject me. Could it be that simple?</p>

<p>As it turns out, it was. We added a <code>sleep 3</code> line between the <code>podman run</code> and the <code>curl localhost</code> commands and then everything worked as expected. What&rsquo;s apparently happening is the <code>podman run</code> command is starting up the container and nginx server extremely quickly and returning to the command line. If you don&rsquo;t wait a few seconds, the nginx server doesn&rsquo;t have time to start up and start accepting connection requests.</p>

<p>In our testing with Docker, this wasn&rsquo;t the case. I didn&rsquo;t dig into it deeply but my assumption is the time that Docker spends talking to the Docker daemon gives the nginx server enough time to come up fully. This is what really makes Buildah and Podman very useful and powerful, no daemon, less overhead. But you need to take that into account for demos!</p>

<p>So problems are indeed what engineers solve and often times it&rsquo;s not always in the code itself. When looking at problems it often is good to step back a little bit further and not get too focused on the bits and the bytes. This problem helped me to remember this lesson myself. Who knows maybe your next problem will also prove to be an opportunity in disguise.</p>

<p><strong>Buildah == Simplicity</strong></p>

</section>
<footer class='post-meta'>

<p>
<small>Share this post:</small>
<span class='btn-group' id='social_share'>
<a class='btn btn-default btn-xs' href='http://twitter.com/share?text=yourtext&amp;url=http://www.projectatomic.io/blog/2018/06/problems-are-opportunities-in-disguise/' role='button' title='Twitter'>
<i class='fa fa-twitter'></i>
Twitter
</a>
<a class='btn btn-default btn-xs' href='http://www.facebook.com/sharer.php?u=http://www.projectatomic.io/blog/2018/06/problems-are-opportunities-in-disguise/' role='button' title='Facebook'>
<i class='fa fa-facebook'></i>
Facebook
</a>
<a class='btn btn-default btn-xs' href='https://plus.google.com/share?url=http://www.projectatomic.io/blog/2018/06/problems-are-opportunities-in-disguise/' role='button' title='Google'>
<i class='fa fa-google-plus'></i>
Google+
</a>
</span>
</p>

</footer>
</article>

<section id='blog-comments'></section>
</div>
</section>

</section>
</div>
<div class='row'>
<div class='col-md-offset-3 col-md-9 col-lg-offset-2 col-lg-10' id='footer'>
<footer>
<hr class='visible-print'>
<ul class='footer-nav-list'>
<li><a target="_blank" href="https://fedoraproject.org/wiki/Legal:PrivacyPolicy">Privacy Policy</a></li>
</ul>

&copy; 2014&ndash;2021 Project Atomic. Sponsored by Red Hat, Inc.
        <script type="text/javascript">
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http") + "://tracker.osci.io/piwik/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', 4]);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
        g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
        </script>
<noscript><p><img src="https://tracker.osci.io/piwik/piwik.php?idsite=4" style="border:0;" alt="" /></p></noscript>
</footer>
</div>
</div>

</section>

<script src="/javascripts/application.js?1633620584" type="text/javascript"></script>


</body>
</html>
